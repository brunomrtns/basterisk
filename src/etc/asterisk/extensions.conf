[globals]
default_ddi=55
default_ddd=48

;================================================================
[general]
autofallthrough=yes


;================================================================
;=============================================== Inbound Contexts

; Intelbras GW201E
[in-ip]
exten => _[+0-9a-z*#() ]!,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,Set(ACCOUNT=${CHANNEL:6:3})
		same => n,Set(ROUTE=)
		same => n,Set(FROM=${CALLERID(num)})
		same => n,Set(TO=${EXTEN})
		same => n,Gosub(in-verify,s,1)

; Khomp UMG Modular 300
; Khomp UMG1200
[in-oaccount3-oroute2]
exten => _[+0-9a-z*#() ]!,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,Set(ACCOUNT=${CALLERID(num):0:3})
		same => n,Set(ROUTE=${CALLERID(num):3:2})
		same => n,Set(FROM=${CALLERID(num):5})
		same => n,Set(TO=${EXTEN})
		same => n,Gosub(in-verify,s,1)

; Grandstream GXW4501
[in2-oaccount3-oroute2]
exten => _[+0-9a-z*#() ]!,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,Set(ACCOUNT=${EXTEN:0:3})
		same => n,Set(ROUTE=${EXTEN:3:2})
		same => n,Set(FROM=${CALLERID(num)})
		same => n,Set(TO=${EXTEN:5})
		same => n,Gosub(in-verify,s,1)

; Intelbras GW208O
[in3-oaccount3-oroute2]
exten => _[+0-9a-z*#() ]!,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,Set(ACCOUNT=${CALLERID(num):0:3})
		same => n,Set(ROUTE=${CALLERID(num):3:2})
		same => n,Set(FROM=${CALLERID(name)})
		same => n,Set(TO=${EXTEN})
		same => n,Gosub(in-verify,s,1)

; Bruno SCv3
[in4-oaccount7-oroute0]
exten => _[+0-9a-z*#() ]!,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,Set(ACCOUNT=${CALLERID(num):0:7})
		same => n,Set(ROUTE=)
		same => n,Set(FROM=${CALLERID(num):7})
		same => n,Set(TO=${EXTEN})
		same => n,Gosub(in-verify,s,1)

[in4-oaccount7-oroute0-messages]
exten => _[+0-9a-z*#() ]!,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,Set(ACCOUNT=${MESSAGE(from):5:7})
		same => n,Set(ROUTE=)
		same => n,Set(FROM=${MESSAGE(from):12:9})
		same => n,Set(TO=${EXTEN})
		same => n,Goto(in-verify-messages,s,1)

;================================================================
[default]

exten => _*131,1,NoOp(VoiceMail.)
       same => n,Answer(500)
       same => n,VoiceMailMain()
       same => n,PlayBack(vm-goodbye)
       same => n,HangUp()

exten => *550,1,NoOp(Park)
      same => n,Goto(parkedcalls,550,1)
      same => n,Hangup()

exten => *5500,1,NoOp(Park)
       same => n,Goto(parkedcalls,550,1)
       same => n,Hangup()

exten => _*68.,1,NoOp(Park)
       same => n,Goto(parkedcalls,${EXTEN:3},1)
       same => n,Hangup()
       same => hint,park:${EXTEN:3}@parkedcalls

exten => _*60.,1,NoOp(Call PickUp!!!)
       same => n,PickUp(${EXTEN:3})
       same => n,Hangup


exten => _*821XXXXX.,1,Gosub(out-account3-route2,${EXTEN:4},1)
exten => _*821[a-z][a-z][a-z]XXXX.,1,Gosub(out-account7-route0,${EXTEN:4},1)

exten => _0.,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,NoOp(Call from ${CALLERID(all)} to external number ${EXTEN} through route 0)
		same => n,Gosub(parsing-number,${FILTER(0123456789,${STRREPLACE(EXTEN,+,00)})},1(${default_ddi},${default_ddd}))
		same => n,Gosub(destcsp,finddestcsp,1)
		same => n,Gosub(routes,findroute,1)
		same => n,Hangup

exten => _ZXXX,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,GotoIf($["" = "${SHELL(echo -n "${PJSIP_HEADER(read,Call-Info)}" | grep "answer-after=0")}"]?Call:Intercom)
		same => n(Call),NoOp(Call from ${CALLERID(all)} to internal number ${EXTEN})
		same => n,Dial(${IF($["${PJSIP_DIAL_CONTACTS(${EXTEN})}" = ""]?"PJSIP/${EXTEN}":${PJSIP_DIAL_CONTACTS(${EXTEN})})},60,tk)
		same => n,Hangup
		same => n(Intercom),NoOp(Intercom from ${CALLERID(all)} to internal number ${EXTEN})
		same => n,Page(PJSIP/${EXTEN},isdb(Intercom_handler^addheader^1))
		same => n,Hangup
		same => hint,PJSIP/${EXTEN}

;================================================================
[default-messages]

exten => _*821XXXXX.,1,Gosub(out-account3-route2-messages,${EXTEN:4},1)
exten => _*821[a-z][a-z][a-z]XXXX.,1,Gosub(out-account7-route0-messages,${EXTEN:4},1)

exten => _0.,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,NoOp(Message from ${MESSAGE(from)} to external number ${EXTEN:1} through route 0)
		same => n,Gosub(parsing-number,${FILTER(0123456789,${STRREPLACE(EXTEN,+,00)})},1(${default_ddi},${default_ddd}))
		same => n,Gosub(destcsp,finddestcsp,1)
		same => n,Gosub(routes-messages,findroute,1)

exten => _ZXXX,1,NoOp(>>>>>> ${CONTEXT} <<<<<<)
		same => n,NoOp(Message from ${MESSAGE(from)} to internal number ${EXTEN})
		same => n,ExecIf($[${REGEX(".*\@" ${MESSAGE(from)})}]?Set(MESSAGE(from)=${CUT(MESSAGE(from),@,1)}))
		same => n,ExecIf($[${REGEX(":.*" ${MESSAGE(from)})}]?Set(MESSAGE(from)=${CUT(MESSAGE(from),:,2)}))
		same => n,MessageSend(pjsip:${EXTEN})


;================================================================
;============================================== Function Contexts

[in-verify]
exten => s,1,NoOp(Incomming call from ${FROM}, through account ${ACCOUNT}, route ${ROUTE}, to ${TO})
		same => n,Gosub(parsing-number,0${FILTER(0123456789,${STRREPLACE(FROM,+,00)})},1(${PJSIP_AOR(${ACCOUNT},@DDI)},${PJSIP_AOR(${ACCOUNT},@DDD)}))
		same => n,GotoIf($["${INTERNATIONALNUMBER}" = ""]?hangup)
		same => n,Set(CALLERID(all)="External Caller ${INTERNATIONALNUMBER}" <0${INTERNATIONALNUMBER}>)
		same => n,Gosub(parsing-number,0${FILTER(0123456789,${STRREPLACE(TO,+,00)})},1(${PJSIP_AOR(${ACCOUNT},@DDI)},${PJSIP_AOR(${ACCOUNT},@DDD)}))
		same => n,GotoIf($[ $["${INTERNATIONALNUMBER}" = ""] | $["${INTERNATIONALNUMBER:-8:4}" != "3281"] | $["${INTERNATIONALNUMBER:-4:1}" = "0"] ]?hangup)
		same => n,Goto(default,${INTERNATIONALNUMBER:-4},1)
		same => n(hangup),Hangup(21)

[in-verify-messages]
exten => s,1,NoOp(Incomming message from ${MESSAGE(from)}, through account ${ACCOUNT}, route ${ROUTE}, to ${TO})
		same => n,Gosub(parsing-number,0${FILTER(0123456789,${STRREPLACE(FROM,+,00)})},1(${PJSIP_AOR(${ACCOUNT},@DDI)},${PJSIP_AOR(${ACCOUNT},@DDD)}))
		same => n,GotoIf($["${INTERNATIONALNUMBER}" = ""]?hangup)
		same => n,Set(MESSAGE(from)=0${INTERNATIONALNUMBER})
		same => n,Gosub(parsing-number,0${FILTER(0123456789,${STRREPLACE(TO,+,00)})},1(${PJSIP_AOR(${ACCOUNT},@DDI)},${PJSIP_AOR(${ACCOUNT},@DDD)}))
		same => n,GotoIf($[ $["${INTERNATIONALNUMBER}" = ""] | $["${INTERNATIONALNUMBER:-8:4}" != "3281"] | $["${INTERNATIONALNUMBER:-4:1}" = "0"] ]?hangup)
		same => n,Goto(default-messages,${INTERNATIONALNUMBER:-4},1)
		same => n(hangup),Hangup(21)




[Intercom_handler]
exten => addheader,1,Set(PJSIP_HEADER(add,Call-Info)=answer-after=0)
		same => n,Return()


[greeting]
exten => 400,1,Answer
exten => 400,n,Background("output")
exten => 400,n,WaitExten(50000)
exten => 400,n,HangUp()


[sms_sender]
exten => 401,1,Set(MESSAGE(body)="Oiiiii")
		same => n,Goto(default-messages,aaa4000048991256095,1)







;================================================================
[parsing-number]
exten => _0XXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} (Phone Number 8)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${ARG2})
		same => n,Set(NUMBER=${EXTEN:1:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _0XXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} (Phone Number 9)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${ARG2})
		same => n,Set(NUMBER=${EXTEN:1:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _09090XXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 9090(Phone Number 8)")
		same => n,Set(COLLECTCALL=yes)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${ARG2})
		same => n,Set(NUMBER=${EXTEN:5:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _09090XXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 9090(Phone Number 9)")
		same => n,Set(COLLECTCALL=yes)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${ARG2})
		same => n,Set(NUMBER=${EXTEN:5:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _0ZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} (DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:1:2})
		same => n,Set(NUMBER=${EXTEN:3:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _0ZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} (DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:1:2})
		same => n,Set(NUMBER=${EXTEN:3:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _00ZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 0(DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:2:2})
		same => n,Set(NUMBER=${EXTEN:4:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _00ZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 0(DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:2:2})
		same => n,Set(NUMBER=${EXTEN:4:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _00ZZZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 0(CSP)(DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=${EXTEN:2:2})
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:4:2})
		same => n,Set(NUMBER=${EXTEN:6:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _00ZZZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 0(CSP)(DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=${EXTEN:2:2})
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:4:2})
		same => n,Set(NUMBER=${EXTEN:6:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _090ZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 90(DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=yes)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:3:2})
		same => n,Set(NUMBER=${EXTEN:5:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _090ZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 90(DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=yes)
		same => n,Set(CSP=)
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:3:2})
		same => n,Set(NUMBER=${EXTEN:5:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _090ZZZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 90(CSP)(DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=yes)
		same => n,Set(CSP=${EXTEN:3:2})
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:5:2})
		same => n,Set(NUMBER=${EXTEN:7:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _090ZZZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 90(CSP)(DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=yes)
		same => n,Set(CSP=${EXTEN:3:2})
		same => n,Set(DDI=${ARG1})
		same => n,Set(DDD=${EXTEN:5:2})
		same => n,Set(NUMBER=${EXTEN:7:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _00055ZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 00(55)(DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${EXTEN:3:2})
		same => n,Set(DDD=${EXTEN:5:2})
		same => n,Set(NUMBER=${EXTEN:7:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _00055ZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 00(55)(DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=)
		same => n,Set(DDI=${EXTEN:3:2})
		same => n,Set(DDD=${EXTEN:5:2})
		same => n,Set(NUMBER=${EXTEN:7:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _000ZZ55ZZXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 00(CSP)(55)(DDD)(Phone Number 8)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=${EXTEN:3:2})
		same => n,Set(DDI=${EXTEN:5:2})
		same => n,Set(DDD=${EXTEN:7:2})
		same => n,Set(NUMBER=${EXTEN:9:8})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _000ZZ55ZZXXXXXXXXX,1,NoOp("Parsing number: ${EXTEN:1} 00(CSP)(55)(DDD)(Phone Number 9)")
		same => n,Set(COLLECTCALL=no)
		same => n,Set(CSP=${EXTEN:3:2})
		same => n,Set(DDI=${EXTEN:5:2})
		same => n,Set(DDD=${EXTEN:7:2})
		same => n,Set(NUMBER=${EXTEN:9:9})
		same => n,Set(INTERNATIONALNUMBER=00${DDI}${DDD}${NUMBER})
		same => n(return),Return()

exten => _0.,1,NoOp("Parsing number: ${EXTEN:1} (Unknown)")
		same => n,Set(COLLECTCALL=)
		same => n,Set(CSP=)
		same => n,Set(DDI=)
		same => n,Set(DDD=)
		same => n,Set(NUMBER=${EXTEN:1})
		same => n,Set(INTERNATIONALNUMBER=)
		same => n(return),Return()


;================================================================
[destcsp]
exten => finddestcsp,1,Set(DESTCSP=${SHELL(grep "${DDD}${NUMBER}" /etc/asterisk/portability_db.csv | sed "s/.*,//g" | tr -d '\012\015')})
		same => n,GotoIf($["${DESTCSP}" = ""]?:return)
		same => n,NoOp(${SHELL(perl /etc/asterisk/qualoperadora.pl "${DDD}${NUMBER}" >> /etc/asterisk/portability_db.csv)})
		same => n,Set(DESTCSP=${SHELL(grep "${DDD}${NUMBER}" /etc/asterisk/portability_db.csv | sed "s/.*,//g" | tr -d '\012\015')})
		same => n,ExecIf($["${DESTCSP}" = ""]?Set(CSP=${DESTCSP}))
		same => n(return),Return()


;================================================================
[dialingnumber]
exten => dialingnumber,1,NoOp(CSP=${CSP}, DDI=${DDI}, DDD=${DDD}, NUMBER=${NUMBER}, DESTCSP=${DESTCSP}, Collect_Call=${COLLECTCALL}, LDDI=${ARG1}, LDDD=${ARG2})
		same => n,Set(DIALINGNUMBER=${NUMBER})
		same => n,GotoIf($[ $["${ARG1}" = "55"] & $["${DDI}" = "55"] ]?:return)
		same => n,ExecIf($[ $[ "${COLLECTCALL}" = "yes" ] & $[ $[ "${CSP}" != "" ] | $[ "${ARG2}" != "${DDD}" ] ] ]?Set(DIALINGNUMBER=90${CSP}${DDD}${NUMBER}))
		same => n,ExecIf($[ $[ "${COLLECTCALL}" = "yes" ] & $[ "${CSP}" = "" ] & $[ "${ARG2}" != "${DDD}" ] ]?Set(DIALINGNUMBER=90${DDD}${NUMBER}))
		same => n,ExecIf($[ $[ "${COLLECTCALL}" = "yes" ] & $[ "${CSP}" = "" ] & $[ "${ARG2}" = "${DDD}" ] ]?Set(DIALINGNUMBER=9090${NUMBER}))
		same => n,ExecIf($[ $[ "${COLLECTCALL}" != "yes" ] & $[ $[ "${CSP}" != "" ] | $[ "${ARG2}" != "${DDD}" ] ] ]?Set(DIALINGNUMBER=0${CSP}${DDD}${NUMBER}))
		same => n,ExecIf($[ $[ "${COLLECTCALL}" != "yes" ] & $[ "${CSP}" = "" ] & $[ "${ARG2}" != "${DDD}" ] ]?Set(DIALINGNUMBER=0${DDD}${NUMBER}))
		same => n,ExecIf($[ $[ "${COLLECTCALL}" != "yes" ] & $[ "${CSP}" = "" ] & $[ "${ARG2}" = "${DDD}" ] ]?Set(DIALINGNUMBER=${NUMBER}))
		same => n(return),Return()


;================================================================
;================================================= Route Contexts

[routes]

exten => route1,1,Gosub(dialingnumber,dialingnumber,1(${PJSIP_AOR(${ARG2},@DDI)},${PJSIP_AOR(${ARG2},@DDD)}))
			same => n,NoOp(${ARG1} - account ${ARG2} - route ${ARG3} - Dialing Number ${DIALINGNUMBER})
			same => n,Gosub(out-account3-route2,${ARG2}${ARG3}${DIALINGNUMBER},1)
			same => n,Return()

exten => route2,1,Gosub(dialingnumber,dialingnumber,1(${PJSIP_AOR(${ARG2},@DDI)},${PJSIP_AOR(${ARG2},@DDD)}))
			same => n,NoOp(${ARG1} - account ${ARG2} - Dialing Number ${DIALINGNUMBER})
			same => n,Gosub(out-account7-route0,${ARG2}${DIALINGNUMBER},1)
			same => n,Return()

;# CSP das operadoras
;#    12 =>  "CTBC"
;#    14 =>  "Brasil Telecom"
;#    20 =>  "Vivo"
;#    21 =>  "Claro"
;#    31 =>  "Oi"
;#    24 =>  "Amazonia"
;#    37 =>  "Unicel"
;#    41 =>  "TIM"
;#    77 =>  "Nextel"
;#    43 =>  "SerComercio"
;#    81 =>  "Datora"

exten => findroute,1,NoOp(Routing...)

		same => n(pri00),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "21" ] ]?:pri01)

			same => n,Gosub(route1,1(GW208O,100,00))
			same => n,Gosub(route1,1(GW208O,101,00))
			same => n,Gosub(route1,1(GW208O,102,00))
			same => n,Gosub(route1,1(GW208O,103,00))
			same => n,Gosub(route1,1(GW208O,104,00))
			same => n,Gosub(route1,1(GW208O,105,00))
			same => n,Gosub(route1,1(GW208O,106,00))
			same => n,Gosub(route1,1(GW208O,107,00))
			same => n,Return()

		same => n(pri01),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] & $[ "${DESTCSP}" = "20" ] ]?:pri02)

			same => n,Gosub(route1,1(UMG Modular 300,111,02))
			same => n,Gosub(route2,1(SmartCell V3,aaa4002))
			same => n,Return()

		same => n(pri02),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] & $[ "${DESTCSP}" = "21" ] ]?:pri03)

			same => n,Gosub(route1,1(UMG Modular 300,111,00))
			same => n,Gosub(route2,1(SmartCell V3,aaa4001))
			same => n,Return()

		same => n(pri03),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] & $[ "${DESTCSP}" = "41" ] ]?:pri04)

			same => n,Gosub(route1,1(UMG Modular 300,111,01))
			same => n,Gosub(route2,1(SmartCell V3,aaa4000))
			same => n,Gosub(route2,1(SmartCell V3,aaa4003))
			same => n,Return()

		same => n(pri04),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] ]?:pri05)

			same => n,Gosub(route1,1(UMG 1200,112,00))
			same => n,Gosub(route1,1(GXW4501,113,00))
			same => n,Return()

		same => n(pri05),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "61" ] & $[ "${DESTCSP}" = "21" ] ]?:pri06)

			same => n,Gosub(route1,1(UMG Modular 300,110,01))
			same => n,Return()

		same => n(pri06),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "61" ] & $[ "${DESTCSP}" = "41" ] ]?:pri07)

			same => n,Gosub(route1,1(UMG Modular 300,110,02))
			same => n,Return()

		same => n(pri07),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "61" ] ]?:pri08)

			same => n,Gosub(route1,1(UMG Modular 300,110,00))
			same => n,Gosub(route1,1(GW201E,109,00))
			same => n,Return()

		same => n(pri08),NoOp(Default Route.)

			same => n,Gosub(route1,1(UMG 1200,112,00))
			same => n,Return()


;================================================================
[routes-messages]

exten => route1,1,Gosub(dialingnumber,dialingnumber,1(${PJSIP_AOR(${ARG2},@DDI)},${PJSIP_AOR(${ARG2},@DDD)}))
			same => n,NoOp(${ARG1} - account ${ARG2} - route ${ARG3} - Dialing Number ${DIALINGNUMBER})
			same => n,Gosub(out-account3-route2-messages,${ARG2}${ARG3}${DIALINGNUMBER},1)
			same => n,Return()

exten => route2,1,Gosub(dialingnumber,dialingnumber,1(${PJSIP_AOR(${ARG2},@DDI)},${PJSIP_AOR(${ARG2},@DDD)}))
			same => n,NoOp(${ARG1} - account ${ARG2} - Dialing Number ${DIALINGNUMBER})
			same => n,Gosub(out-account7-route0-messages,${ARG2}${DIALINGNUMBER},1)
			same => n,Return()

;# CSP das operadoras
;#    12 =>  "CTBC"
;#    14 =>  "Brasil Telecom"
;#    20 =>  "Vivo"
;#    21 =>  "Claro"
;#    31 =>  "Oi"
;#    24 =>  "Amazonia"
;#    37 =>  "Unicel"
;#    41 =>  "TIM"
;#    77 =>  "Nextel"
;#    43 =>  "SerComercio"
;#    81 =>  "Datora"

exten => findroute,1,NoOp(Routing...)

		same => n(pri01),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] & $[ "${DESTCSP}" = "20" ] ]?:pri02)

			;same => n,Gosub(route1,1(UMG Modular 300,111,02))
			same => n,Gosub(route2,1(SmartCell V3,aaa4002))
			same => n,Return()

		same => n(pri02),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] & $[ "${DESTCSP}" = "21" ] ]?:pri03)

			same => n,Gosub(route1,1(UMG Modular 300,111,00))
			same => n,Gosub(route2,1(SmartCell V3,aaa4001))
			same => n,Return()

		same => n(pri03),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] & $[ "${DESTCSP}" = "41" ] ]?:pri04)

			same => n,Gosub(route1,1(UMG Modular 300,111,01))
			same => n,Gosub(route2,1(SmartCell V3,aaa4000))
			same => n,Gosub(route2,1(SmartCell V3,aaa4003))
			same => n,Return()

		same => n(pri04),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "48" ] ]?:pri05)

			same => n,Gosub(route1,1(UMG 1200,112,00))
			same => n,Gosub(route1,1(GXW4501,113,00))
			same => n,Return()

		same => n(pri05),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "61" ] & $[ "${DESTCSP}" = "21" ] ]?:pri06)

			same => n,Gosub(route1,1(UMG Modular 300,110,01))
			same => n,Return()

		same => n(pri06),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "61" ] & $[ "${DESTCSP}" = "41" ] ]?:pri07)

			same => n,Gosub(route1,1(UMG Modular 300,110,02))
			same => n,Return()

		same => n(pri07),GotoIf($[ $[ "${DDI}" = "55" ] & $[ "${DDD}" = "61" ] ]?:pri08)

			same => n,Gosub(route1,1(UMG Modular 300,110,00))
			same => n,Gosub(route1,1(GW201E,109,00))
			same => n,Return()

		same => n(pri08),NoOp(Default Route.)

			same => n,Gosub(route1,1(UMG 1200,112,00))
			same => n,Return()




;================================================================
;=============================================== Outgoing Contexts

[out-account3-route2]
exten => _XXXXX.,1,NoOp(<<<<<< ${CONTEXT} >>>>>>)
		same => n,NoOp(Outgoing call from ${CALLERID(all)}, through account ${EXTEN:0:3}, at route ${EXTEN:3:2}, to ${EXTEN:5})
		same => n,Set(CALLERIDBKP=${CALLERID(all)})
		same => n,Set(CALLERID(all)="${CALLERID(name)}" <00${default_ddi}${default_ddd}3281${CALLERID(num):-4}>)
		same => n,GotoIf($["${INTERNATIONALNUMBER}" = ""]?dial)
		same => n,Set(CONNECTEDLINE(num,i)=0${INTERNATIONALNUMBER})
		same => n,Set(CONNECTEDLINE(num-pres)=allowed)
		same => n(dial),Dial(PJSIP/${EXTEN}@${EXTEN:0:3},60,tkI)
		same => n,NoOp(DIALSTATUS = ${DIALSTATUS})
		same => n,GotoIf($[ $["${DIALSTATUS}" = "CHANUNAVAIL"] | $["${DIALSTATUS}" = "CONGESTION"] | $["${DIALSTATUS}" = "NOANSWER"] ]?return)
		same => n,Hangup
		same => n(return),Set(CALLERID(all)=${CALLERIDBKP})
		same => n,Return()

[out-account7-route0]
exten => _[a-z][a-z][a-z]XXXX.,1,NoOp(<<<<<< ${CONTEXT} >>>>>>)
		same => n,NoOp(Outgoing call from ${CALLERID(all)}, through account ${EXTEN:0:7}, to ${EXTEN:7})
		same => n,Set(CALLERIDBKP=${CALLERID(all)})
		same => n,Set(CALLERID(all)="${CALLERID(name)}" <00${default_ddi}${default_ddd}3281${CALLERID(num):-4}>)
		same => n,GotoIf($["${INTERNATIONALNUMBER}" = ""]?dial)
		same => n,Set(CONNECTEDLINE(num,i)=0${INTERNATIONALNUMBER})
		same => n,Set(CONNECTEDLINE(num-pres)=allowed)
		same => n(dial),Dial(PJSIP/${EXTEN}@${EXTEN:0:7},60,tkI)
		same => n,NoOp(DIALSTATUS = ${DIALSTATUS})
		same => n,GotoIf($[ $["${DIALSTATUS}" = "CHANUNAVAIL"] | $["${DIALSTATUS}" = "CONGESTION"] | $["${DIALSTATUS}" = "NOANSWER"] ]?return)
		same => n,Hangup
		same => n(return),Set(CALLERID(all)=${CALLERIDBKP})
		same => n,Return()


;================================================================
[out-account3-route2-messages]
exten => _XXXXX.,1,NoOp(<<<<<< ${CONTEXT} >>>>>>)
		same => n,NoOp(Outgoing message from ${MESSAGE(from)}, through account ${EXTEN:0:3}, at route ${EXTEN:3:2}, to ${EXTEN:5})
		same => n,Set(MESSAGEFROMBKP=${MESSAGE(from)})
		same => n,ExecIf($[${REGEX(".*\@" ${MESSAGE(from)})}]?Set(MESSAGE(from)=${CUT(MESSAGE(from),@,1)}))
		same => n,ExecIf($[${REGEX(":.*" ${MESSAGE(from)})}]?Set(MESSAGE(from)=${CUT(MESSAGE(from),:,2)}))
		same => n,Set(MESSAGE(from)=00${default_ddi}${default_ddd}3281${MESSAGE(from):-4})
		same => n,Set(IP=${PJSIP_CONTACT(${PJSIP_AOR(${EXTEN:0:3},contact)},uri)})
		same => n,Set(IP=${CUT(IP,@,2)})
		same => n,Set(MESSAGE(to)=sip:${EXTEN}@${IP})
		same => n,MessageSend(pjsip:${EXTEN:0:3}/sip:${EXTEN}@${IP})
		same => n,GotoIf($["${MESSAGE_SEND_STATUS}" = "FAILURE"]?return)
		same => n,Hangup
		same => n(return),Set(MESSAGE(from)=${MESSAGEFROMBKP})
		same => n,Return()

[out-account7-route0-messages]
exten => _[a-z][a-z][a-z]XXXX.,1,NoOp(<<<<<< ${CONTEXT} >>>>>>)
		same => n,NoOp(Outgoing message from ${MESSAGE(from)}, through account ${EXTEN:0:7}, to ${EXTEN:7})
		same => n,Set(MESSAGEFROMBKP=${MESSAGE(from)})
		same => n,ExecIf($[${REGEX(".*\@" ${MESSAGE(from)})}]?Set(MESSAGE(from)=${CUT(MESSAGE(from),@,1)}))
		same => n,ExecIf($[${REGEX(":.*" ${MESSAGE(from)})}]?Set(MESSAGE(from)=${CUT(MESSAGE(from),:,2)}))
		same => n,Set(MESSAGE(from)=00${default_ddi}${default_ddd}3281${MESSAGE(from):-4})
		same => n,Set(IP=${PJSIP_CONTACT(${PJSIP_AOR(${EXTEN:0:7},contact)},uri)})
		same => n,Set(IP=${CUT(IP,@,2)})
		same => n,Set(MESSAGE(to)=sip:${EXTEN}@${IP})
		same => n,MessageSend(pjsip:${EXTEN:0:7}/sip:${EXTEN}@${IP})
        same => n,GotoIf($["${MESSAGE_SEND_STATUS}" = "FAILURE"]?return)
		same => n,Hangup
		same => n(return),Set(MESSAGE(from)=${MESSAGEFROMBKP})
		same => n,Return()

